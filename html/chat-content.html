<!-- Dynamic Chat Interface with System Prompt Configuration -->
<div class="dynamic-chat-container">
    <!-- Avatar Selection Interface -->
    <div class="avatar-selection-interface" id="avatarSelectionInterface">
        <div class="config-header" style="margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; margin-bottom: 0.25rem;">Choose Your AI Companion's Avatar</h3>
            <!-- <p class="config-description" style="font-size: 0.85rem;">Select a character to represent your AI companion.</p> -->
        </div>

        <div class="avatar-grid">
            <!-- Avatar options will be generated by JavaScript -->
        </div>

        <div class="avatar-selection-actions" style="display: flex; justify-content: center; margin-top: 2rem;">
            <button type="button" class="btn btn-primary" id="confirmAvatarBtn" disabled style="min-width: 200px;">
                Continue with Selected Avatar â†’
            </button>
        </div>
    </div>

    <!-- System Prompt Configuration Interface -->
    <div class="system-prompt-interface" id="systemPromptInterface" style="display: none;">
        <div id="selectedAvatarDisplay" style="display: none; position: absolute; top: 1.5rem; left: 1rem; z-index: 5;">
            <img id="selectedAvatarImage" src="" alt="Selected Avatar" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; box-shadow: var(--shadow-md);" />
        </div>
        <div class="config-header" style="margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; margin-bottom: 0.25rem;">Configure Your AI Companion</h3>
            <p class="config-description" style="font-size: 0.85rem;">Customize your AI companion's personality and behavior so that it can emotional provide support through difficult times.</p>
        </div>

        <div class="config-form">
            <!-- Left Column: System Prompt Editor -->
            <div class="system-prompt-editor-column">
                <div class="form-group">
                    <label for="systemPromptInput" class="form-label" style="font-size: 0.875rem;">System Prompt</label>
                    <textarea 
                        class="form-control system-prompt-textarea" 
                        id="systemPromptInput" 
                        rows="20" 
                        placeholder="Describe your character's behavior here"
                        style="padding: 0.75rem; font-size: 0.875rem; font-family: 'Courier New', monospace;"></textarea>
                    <!-- Character Counter -->
                    <div id="characterCounter" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                        <span id="charCount">0</span> / 100 characters minimum
                    </div>
                </div>
                <!-- Submit Prompt Button -->
                <div class="submit-prompt-button" style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-shrink: 0;">
                    <button type="button" class="btn btn-primary" id="submitPromptBtn" disabled style="flex: 1;">
                        <i class="fas fa-paper-plane"></i> Submit Prompt
                    </button>
                </div>
                <!-- Persona Check Buttons - Hidden, survey triggered automatically -->
                <div class="persona-check-buttons" style="display: none; gap: 0.5rem; margin-top: 0.75rem; flex-shrink: 0;">
                    <button type="button" class="btn btn-secondary" id="testPersonaBtn" title="Test with simulated data" style="flex: 1;">
                        <i class="fas fa-flask"></i> Test Persona
                    </button>
                    <button type="button" class="btn btn-secondary" id="checkPersonaBtn" style="flex: 1;">
                        <i class="fas fa-user-check"></i> Check Persona
                    </button>
                </div>
            </div>

            <!-- Right Column: Persona Analysis / Survey -->
            <div class="persona-analysis-column">
                <div class="persona-section-wrapper">
                    <!-- Initial Placeholder -->
                    <div id="initialPlaceholder" class="persona-placeholder">
                        <div style="text-align: center; color: var(--text-muted); padding: 3rem 2rem;">
                            <i class="fas fa-arrow-left" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p style="margin: 0; font-size: 1.1rem;">Click "Submit Prompt" to begin assessment</p>
                        </div>
                    </div>

                    <!-- Pre-Task Survey (shown after submit) -->
                    <div id="preTaskSurveyContainer" class="survey-container" style="display: none;">
                        <div class="survey-content-inline" id="surveyPhasesContainer">
                            <!-- Survey phases will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- Persona Visualization (shown after survey) -->
                    <div class="persona-visualization" id="personaVisualization" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <h4 style="margin: 0;">Persona Analysis</h4>
                                <button type="button" class="btn btn-secondary" id="visualizationHelpBtn" title="How to interpret this visualization" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                            <button type="button" class="btn btn-secondary" id="toggleLayoutBtn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; display: none;">
                                <i class="fas fa-exchange-alt"></i> <span id="layoutModeText">Mirrored</span>
                            </button>
                        </div>
                        <div id="personaChart" class="persona-chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="config-actions">
            <button type="button" class="btn btn-secondary" id="resetConfig">Reset to Default</button>
            <button type="button" class="btn btn-primary" id="startChatBtn">Start Chat</button>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-interface" id="chatInterface" style="display: none;">
        <!-- Interface Controls -->
        <div class="interface-controls" style="display: flex; gap: 0.5rem; padding: 1rem; border-bottom: 1px solid var(--border-color); justify-content: space-between; align-items: center;">
            <button class="btn btn-secondary" id="backToConfigBtn">
                <i class="fas fa-cog"></i> Back to Configuration
            </button>
            <!-- Timer Display -->
            <div class="timer-display" id="timerDisplay" style="display: none;">
                <i class="fas fa-clock"></i>
                <span id="timerText">0:00</span>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="messages-container" id="messagesContainer">
            <div class="message assistant-message" data-message-id="1">
                <div class="message-avatar" id="initialMessageAvatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-text">
                        Hi there!
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="input-wrapper">
                <!-- <div class="input-actions">
                    <button class="action-btn" id="attachBtn" title="Attach file">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="action-btn" id="imageBtn" title="Send image">
                        <i class="fas fa-image"></i>
                    </button>
                </div> -->
                <div class="input-field-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Type your message here..."
                        rows="1"
                    ></textarea>
                    <button class="send-button" id="sendBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <div class="input-footer">
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>AI is typing...</span>
                </div>
                <div class="input-hints">
                    <span>Press Enter to send, Shift+Enter for new line</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Post-Task Survey Modal -->
    <div class="post-survey-modal" id="postSurveyModal" style="display: none;">
        <div class="post-survey-overlay"></div>
        <div class="post-survey-content">
            <div class="post-survey-header">
                <h3>Post-Interaction Survey</h3>
                <p>Thank you for participating! Please answer the following questions about your experience.</p>
            </div>

            <!-- Phase 1: Likert Scale Questions -->
            <div class="post-survey-phase" id="postSurveyPhase1">
                <div class="post-survey-questions">
                    <!-- Question 1 -->
                    <div class="survey-question">
                        <label class="question-label">1. How well could you predict unintended behaviors from your system prompt?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="post_q1" value="1" id="post_q1_1">
                                <label for="post_q1_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q1" value="2" id="post_q1_2">
                                <label for="post_q1_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q1" value="3" id="post_q1_3">
                                <label for="post_q1_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q1" value="4" id="post_q1_4">
                                <label for="post_q1_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q1" value="5" id="post_q1_5">
                                <label for="post_q1_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q1" value="6" id="post_q1_6">
                                <label for="post_q1_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q1" value="7" id="post_q1_7">
                                <label for="post_q1_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Not at all</span>
                            <span>Extremely well</span>
                        </div>
                    </div>

                    <!-- Question 2 -->
                    <div class="survey-question">
                        <label class="question-label">2. How well could you predict negative unintended behaviors from your system prompt?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="post_q2" value="1" id="post_q2_1">
                                <label for="post_q2_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q2" value="2" id="post_q2_2">
                                <label for="post_q2_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q2" value="3" id="post_q2_3">
                                <label for="post_q2_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q2" value="4" id="post_q2_4">
                                <label for="post_q2_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q2" value="5" id="post_q2_5">
                                <label for="post_q2_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q2" value="6" id="post_q2_6">
                                <label for="post_q2_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q2" value="7" id="post_q2_7">
                                <label for="post_q2_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Not at all</span>
                            <span>Extremely well</span>
                        </div>
                    </div>

                    <!-- Question 3 -->
                    <div class="survey-question">
                        <label class="question-label">3. AI models have demonstrated both beneficial and detrimental outcomes, including documented cases of AI-induced psychosis and the encouragement of harmful behaviors, alongside instances of providing constructive support and guidance. Given this dichotomous nature of AI behavior, to what extent do you trust AI systems, and what factors inform your assessment of their reliability and safety?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="post_q3" value="1" id="post_q3_1">
                                <label for="post_q3_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q3" value="2" id="post_q3_2">
                                <label for="post_q3_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q3" value="3" id="post_q3_3">
                                <label for="post_q3_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q3" value="4" id="post_q3_4">
                                <label for="post_q3_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q3" value="5" id="post_q3_5">
                                <label for="post_q3_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q3" value="6" id="post_q3_6">
                                <label for="post_q3_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q3" value="7" id="post_q3_7">
                                <label for="post_q3_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Not at all</span>
                            <span>Completely</span>
                        </div>
                    </div>

                    <!-- Question 4 (Shared - both conditions) -->
                    <div class="survey-question">
                        <label class="question-label">4. Did you arrive at your desired character?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="post_q4" value="1" id="post_q4_1">
                                <label for="post_q4_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q4" value="2" id="post_q4_2">
                                <label for="post_q4_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q4" value="3" id="post_q4_3">
                                <label for="post_q4_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q4" value="4" id="post_q4_4">
                                <label for="post_q4_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q4" value="5" id="post_q4_5">
                                <label for="post_q4_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q4" value="6" id="post_q4_6">
                                <label for="post_q4_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q4" value="7" id="post_q4_7">
                                <label for="post_q4_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Not at all</span>
                            <span>Completely</span>
                        </div>
                    </div>

                    <!-- Question 5 (Visualization condition only) -->
                    <div class="survey-question viz-condition-only" id="post_q5_container" style="display: none;">
                        <label class="question-label">5. Did the visualization help you understand model behavior?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="post_q5" value="1" id="post_q5_1">
                                <label for="post_q5_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q5" value="2" id="post_q5_2">
                                <label for="post_q5_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q5" value="3" id="post_q5_3">
                                <label for="post_q5_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q5" value="4" id="post_q5_4">
                                <label for="post_q5_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q5" value="5" id="post_q5_5">
                                <label for="post_q5_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q5" value="6" id="post_q5_6">
                                <label for="post_q5_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q5" value="7" id="post_q5_7">
                                <label for="post_q5_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Not at all</span>
                            <span>Extremely helpful</span>
                        </div>
                    </div>

                    <!-- Question 6 (Visualization condition only) -->
                    <div class="survey-question viz-condition-only" id="post_q6_container" style="display: none;">
                        <label class="question-label">6. Would you like to see this visualization again in future interactions?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="post_q6" value="1" id="post_q6_1">
                                <label for="post_q6_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q6" value="2" id="post_q6_2">
                                <label for="post_q6_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q6" value="3" id="post_q6_3">
                                <label for="post_q6_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q6" value="4" id="post_q6_4">
                                <label for="post_q6_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q6" value="5" id="post_q6_5">
                                <label for="post_q6_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q6" value="6" id="post_q6_6">
                                <label for="post_q6_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="post_q6" value="7" id="post_q6_7">
                                <label for="post_q6_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Definitely not</span>
                            <span>Definitely yes</span>
                        </div>
                    </div>
                </div>

                <div class="post-survey-actions">
                    <button type="button" class="btn btn-primary" id="postPhase1ProceedBtn" disabled>Continue</button>
                </div>
            </div>

            <!-- Phase 2: Open-Ended Response -->
            <div class="post-survey-phase" id="postSurveyPhase2" style="display: none;">
                <div class="post-survey-questions">
                    <div class="survey-question">
                        <label class="question-label">Please provide your open-ended feedback about the interface and your general thoughts about the experiment:</label>
                        <textarea 
                            id="postOpenEndedResponse" 
                            class="form-control" 
                            rows="8" 
                            placeholder="Share your thoughts here..."
                            style="width: 100%; padding: 0.75rem; font-size: 0.95rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); resize: vertical;"
                        ></textarea>
                    </div>
                </div>

                <div class="post-survey-actions">
                    <button type="button" class="btn btn-secondary" id="postPhase2BackBtn">Back</button>
                    <button type="button" class="btn btn-primary" id="postPhase2SubmitBtn" disabled>Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pre-Task Survey Phases (to be moved into inline container by JS) -->
    <div id="surveyPhasesSource" style="display: none;">
        <div class="survey-phases-wrapper">
                <!-- Phase 1: Initial System Prompt Assessment -->
                <div class="survey-phase" id="surveyPhase1">
                    <div class="phase-content">
                        <div class="phase-header">
                            <h4>Phase 1: Initial Assessment</h4>
                            <p>Please answer the following questions about your system prompt</p>
                        </div>

                        <div class="survey-question">
                        <label class="question-label">1. How well could you predict unintended behaviors from your system prompt?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="phase1_q1" value="1" id="p1q1_1">
                                <label for="p1q1_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q1" value="2" id="p1q1_2">
                                <label for="p1q1_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q1" value="3" id="p1q1_3">
                                <label for="p1q1_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q1" value="4" id="p1q1_4">
                                <label for="p1q1_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q1" value="5" id="p1q1_5">
                                <label for="p1q1_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q1" value="6" id="p1q1_6">
                                <label for="p1q1_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q1" value="7" id="p1q1_7">
                                <label for="p1q1_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Not at all</span>
                            <span>Extremely well</span>
                        </div>
                    </div>

                    <div class="survey-question">
                        <label class="question-label">2. How well could you predict negative unintended behaviors from your system prompt?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="phase1_q2" value="1" id="p1q2_1">
                                <label for="p1q2_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q2" value="2" id="p1q2_2">
                                <label for="p1q2_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q2" value="3" id="p1q2_3">
                                <label for="p1q2_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q2" value="4" id="p1q2_4">
                                <label for="p1q2_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q2" value="5" id="p1q2_5">
                                <label for="p1q2_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q2" value="6" id="p1q2_6">
                                <label for="p1q2_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase1_q2" value="7" id="p1q2_7">
                                <label for="p1q2_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Not at all</span>
                            <span>Extremely well</span>
                        </div>
                    </div>
                    </div>

                    <div class="phase-actions">
                        <button type="button" class="btn btn-primary" id="phase1ProceedBtn" disabled>Proceed</button>
                    </div>
                </div>

                <!-- Phase 2: Trait Predictions -->
                <div class="survey-phase" id="surveyPhase2" style="display: none;">
                    <div class="phase-content">
                        <div class="phase-header">
                            <h4>Phase 2: Trait Predictions</h4>
                            <p>Predict the activation level (0-10) for each trait based on your system prompt</p>
                        </div>

                        <div class="trait-predictions-container">
                        <!-- Trait 1: Empathy (Unempathetic to Empathetic) -->
                        <div class="trait-pair">
                            <div class="trait-item">
                                <div class="trait-header-wrapper">
                                    <div class="trait-endpoints">
                                        <span class="trait-endpoint-label">Unempathetic</span>
                                        <span class="trait-endpoint-label">Empathetic</span>
                                    </div>
                                    <span class="trait-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="trait-tooltip-text"><strong>Empathy:</strong> Ranges from lacking understanding of others' feelings to deeply understanding and sharing them</span>
                                    </span>
                                </div>
                                <div class="trait-scale">
                                    <input type="radio" name="trait_empathy" value="0" id="t_empathy_0"><label for="t_empathy_0">0</label>
                                    <input type="radio" name="trait_empathy" value="1" id="t_empathy_1"><label for="t_empathy_1">1</label>
                                    <input type="radio" name="trait_empathy" value="2" id="t_empathy_2"><label for="t_empathy_2">2</label>
                                    <input type="radio" name="trait_empathy" value="3" id="t_empathy_3"><label for="t_empathy_3">3</label>
                                    <input type="radio" name="trait_empathy" value="4" id="t_empathy_4"><label for="t_empathy_4">4</label>
                                    <input type="radio" name="trait_empathy" value="5" id="t_empathy_5"><label for="t_empathy_5">5</label>
                                    <input type="radio" name="trait_empathy" value="6" id="t_empathy_6"><label for="t_empathy_6">6</label>
                                    <input type="radio" name="trait_empathy" value="7" id="t_empathy_7"><label for="t_empathy_7">7</label>
                                    <input type="radio" name="trait_empathy" value="8" id="t_empathy_8"><label for="t_empathy_8">8</label>
                                    <input type="radio" name="trait_empathy" value="9" id="t_empathy_9"><label for="t_empathy_9">9</label>
                                    <input type="radio" name="trait_empathy" value="10" id="t_empathy_10"><label for="t_empathy_10">10</label>
                                </div>
                            </div>
                        </div>

                        <!-- Trait 2: Encouraging (Discouraging to Encouraging) -->
                        <div class="trait-pair">
                            <div class="trait-item">
                                <div class="trait-header-wrapper">
                                    <div class="trait-endpoints">
                                        <span class="trait-endpoint-label">Discouraging</span>
                                        <span class="trait-endpoint-label">Encouraging</span>
                                    </div>
                                    <span class="trait-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="trait-tooltip-text"><strong>Encouraging:</strong> Ranges from causing loss of confidence to inspiring confidence and hope</span>
                                    </span>
                                </div>
                                <div class="trait-scale">
                                    <input type="radio" name="trait_encouraging" value="0" id="t_encouraging_0"><label for="t_encouraging_0">0</label>
                                    <input type="radio" name="trait_encouraging" value="1" id="t_encouraging_1"><label for="t_encouraging_1">1</label>
                                    <input type="radio" name="trait_encouraging" value="2" id="t_encouraging_2"><label for="t_encouraging_2">2</label>
                                    <input type="radio" name="trait_encouraging" value="3" id="t_encouraging_3"><label for="t_encouraging_3">3</label>
                                    <input type="radio" name="trait_encouraging" value="4" id="t_encouraging_4"><label for="t_encouraging_4">4</label>
                                    <input type="radio" name="trait_encouraging" value="5" id="t_encouraging_5"><label for="t_encouraging_5">5</label>
                                    <input type="radio" name="trait_encouraging" value="6" id="t_encouraging_6"><label for="t_encouraging_6">6</label>
                                    <input type="radio" name="trait_encouraging" value="7" id="t_encouraging_7"><label for="t_encouraging_7">7</label>
                                    <input type="radio" name="trait_encouraging" value="8" id="t_encouraging_8"><label for="t_encouraging_8">8</label>
                                    <input type="radio" name="trait_encouraging" value="9" id="t_encouraging_9"><label for="t_encouraging_9">9</label>
                                    <input type="radio" name="trait_encouraging" value="10" id="t_encouraging_10"><label for="t_encouraging_10">10</label>
                                </div>
                            </div>
                        </div>

                        <!-- Trait 3: Sociality (Antisocial to Social) -->
                        <div class="trait-pair">
                            <div class="trait-item">
                                <div class="trait-header-wrapper">
                                    <div class="trait-endpoints">
                                        <span class="trait-endpoint-label">Antisocial</span>
                                        <span class="trait-endpoint-label">Social</span>
                                    </div>
                                    <span class="trait-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="trait-tooltip-text"><strong>Sociality:</strong> Ranges from avoiding social interaction to actively seeking and enjoying it</span>
                                    </span>
                                </div>
                                <div class="trait-scale">
                                    <input type="radio" name="trait_sociality" value="0" id="t_sociality_0"><label for="t_sociality_0">0</label>
                                    <input type="radio" name="trait_sociality" value="1" id="t_sociality_1"><label for="t_sociality_1">1</label>
                                    <input type="radio" name="trait_sociality" value="2" id="t_sociality_2"><label for="t_sociality_2">2</label>
                                    <input type="radio" name="trait_sociality" value="3" id="t_sociality_3"><label for="t_sociality_3">3</label>
                                    <input type="radio" name="trait_sociality" value="4" id="t_sociality_4"><label for="t_sociality_4">4</label>
                                    <input type="radio" name="trait_sociality" value="5" id="t_sociality_5"><label for="t_sociality_5">5</label>
                                    <input type="radio" name="trait_sociality" value="6" id="t_sociality_6"><label for="t_sociality_6">6</label>
                                    <input type="radio" name="trait_sociality" value="7" id="t_sociality_7"><label for="t_sociality_7">7</label>
                                    <input type="radio" name="trait_sociality" value="8" id="t_sociality_8"><label for="t_sociality_8">8</label>
                                    <input type="radio" name="trait_sociality" value="9" id="t_sociality_9"><label for="t_sociality_9">9</label>
                                    <input type="radio" name="trait_sociality" value="10" id="t_sociality_10"><label for="t_sociality_10">10</label>
                                </div>
                            </div>
                        </div>

                        <!-- Trait 4: Honesty (Sycophantic to Honest) -->
                        <div class="trait-pair">
                            <div class="trait-item">
                                <div class="trait-header-wrapper">
                                    <div class="trait-endpoints">
                                        <span class="trait-endpoint-label">Sycophantic</span>
                                        <span class="trait-endpoint-label">Honest</span>
                                    </div>
                                    <span class="trait-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="trait-tooltip-text"><strong>Honesty:</strong> Ranges from excessive flattery to gain favor to being truthful and genuine</span>
                                    </span>
                                </div>
                                <div class="trait-scale">
                                    <input type="radio" name="trait_honesty" value="0" id="t_honesty_0"><label for="t_honesty_0">0</label>
                                    <input type="radio" name="trait_honesty" value="1" id="t_honesty_1"><label for="t_honesty_1">1</label>
                                    <input type="radio" name="trait_honesty" value="2" id="t_honesty_2"><label for="t_honesty_2">2</label>
                                    <input type="radio" name="trait_honesty" value="3" id="t_honesty_3"><label for="t_honesty_3">3</label>
                                    <input type="radio" name="trait_honesty" value="4" id="t_honesty_4"><label for="t_honesty_4">4</label>
                                    <input type="radio" name="trait_honesty" value="5" id="t_honesty_5"><label for="t_honesty_5">5</label>
                                    <input type="radio" name="trait_honesty" value="6" id="t_honesty_6"><label for="t_honesty_6">6</label>
                                    <input type="radio" name="trait_honesty" value="7" id="t_honesty_7"><label for="t_honesty_7">7</label>
                                    <input type="radio" name="trait_honesty" value="8" id="t_honesty_8"><label for="t_honesty_8">8</label>
                                    <input type="radio" name="trait_honesty" value="9" id="t_honesty_9"><label for="t_honesty_9">9</label>
                                    <input type="radio" name="trait_honesty" value="10" id="t_honesty_10"><label for="t_honesty_10">10</label>
                                </div>
                            </div>
                        </div>

                        <!-- Trait 5: Factual (Hallucinatory to Factual) -->
                        <div class="trait-pair">
                            <div class="trait-item">
                                <div class="trait-header-wrapper">
                                    <div class="trait-endpoints">
                                        <span class="trait-endpoint-label">Hallucinatory</span>
                                        <span class="trait-endpoint-label">Factual</span>
                                    </div>
                                    <span class="trait-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="trait-tooltip-text"><strong>Factual:</strong> Ranges from generating false information to providing accurate, verifiable information</span>
                                    </span>
                                </div>
                                <div class="trait-scale">
                                    <input type="radio" name="trait_hallucination" value="0" id="t_hallucination_0"><label for="t_hallucination_0">0</label>
                                    <input type="radio" name="trait_hallucination" value="1" id="t_hallucination_1"><label for="t_hallucination_1">1</label>
                                    <input type="radio" name="trait_hallucination" value="2" id="t_hallucination_2"><label for="t_hallucination_2">2</label>
                                    <input type="radio" name="trait_hallucination" value="3" id="t_hallucination_3"><label for="t_hallucination_3">3</label>
                                    <input type="radio" name="trait_hallucination" value="4" id="t_hallucination_4"><label for="t_hallucination_4">4</label>
                                    <input type="radio" name="trait_hallucination" value="5" id="t_hallucination_5"><label for="t_hallucination_5">5</label>
                                    <input type="radio" name="trait_hallucination" value="6" id="t_hallucination_6"><label for="t_hallucination_6">6</label>
                                    <input type="radio" name="trait_hallucination" value="7" id="t_hallucination_7"><label for="t_hallucination_7">7</label>
                                    <input type="radio" name="trait_hallucination" value="8" id="t_hallucination_8"><label for="t_hallucination_8">8</label>
                                    <input type="radio" name="trait_hallucination" value="9" id="t_hallucination_9"><label for="t_hallucination_9">9</label>
                                    <input type="radio" name="trait_hallucination" value="10" id="t_hallucination_10"><label for="t_hallucination_10">10</label>
                                </div>
                            </div>
                        </div>

                        <!-- Trait 6: Respectful (Toxic to Respectful) -->
                        <div class="trait-pair">
                            <div class="trait-item">
                                <div class="trait-header-wrapper">
                                    <div class="trait-endpoints">
                                        <span class="trait-endpoint-label">Toxic</span>
                                        <span class="trait-endpoint-label">Respectful</span>
                                    </div>
                                    <span class="trait-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="trait-tooltip-text"><strong>Respectful:</strong> Ranges from harmful and offensive behavior to showing consideration and courtesy</span>
                                    </span>
                                </div>
                                <div class="trait-scale">
                                    <input type="radio" name="trait_toxicity" value="0" id="t_toxicity_0"><label for="t_toxicity_0">0</label>
                                    <input type="radio" name="trait_toxicity" value="1" id="t_toxicity_1"><label for="t_toxicity_1">1</label>
                                    <input type="radio" name="trait_toxicity" value="2" id="t_toxicity_2"><label for="t_toxicity_2">2</label>
                                    <input type="radio" name="trait_toxicity" value="3" id="t_toxicity_3"><label for="t_toxicity_3">3</label>
                                    <input type="radio" name="trait_toxicity" value="4" id="t_toxicity_4"><label for="t_toxicity_4">4</label>
                                    <input type="radio" name="trait_toxicity" value="5" id="t_toxicity_5"><label for="t_toxicity_5">5</label>
                                    <input type="radio" name="trait_toxicity" value="6" id="t_toxicity_6"><label for="t_toxicity_6">6</label>
                                    <input type="radio" name="trait_toxicity" value="7" id="t_toxicity_7"><label for="t_toxicity_7">7</label>
                                    <input type="radio" name="trait_toxicity" value="8" id="t_toxicity_8"><label for="t_toxicity_8">8</label>
                                    <input type="radio" name="trait_toxicity" value="9" id="t_toxicity_9"><label for="t_toxicity_9">9</label>
                                    <input type="radio" name="trait_toxicity" value="10" id="t_toxicity_10"><label for="t_toxicity_10">10</label>
                                </div>
                            </div>
                        </div>

                        <!-- Trait 7: Funniness (Serious to Funny) - Neutral -->
                        <div class="trait-pair">
                            <div class="trait-item">
                                <div class="trait-header-wrapper">
                                    <div class="trait-endpoints">
                                        <span class="trait-endpoint-label">Serious</span>
                                        <span class="trait-endpoint-label">Funny</span>
                                    </div>
                                    <span class="trait-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="trait-tooltip-text"><strong>Funniness:</strong> Ranges from thoughtful and earnest to using wit and humor to entertain</span>
                                    </span>
                                </div>
                                <div class="trait-scale">
                                    <input type="radio" name="trait_funniness" value="0" id="t_funniness_0"><label for="t_funniness_0">0</label>
                                    <input type="radio" name="trait_funniness" value="1" id="t_funniness_1"><label for="t_funniness_1">1</label>
                                    <input type="radio" name="trait_funniness" value="2" id="t_funniness_2"><label for="t_funniness_2">2</label>
                                    <input type="radio" name="trait_funniness" value="3" id="t_funniness_3"><label for="t_funniness_3">3</label>
                                    <input type="radio" name="trait_funniness" value="4" id="t_funniness_4"><label for="t_funniness_4">4</label>
                                    <input type="radio" name="trait_funniness" value="5" id="t_funniness_5"><label for="t_funniness_5">5</label>
                                    <input type="radio" name="trait_funniness" value="6" id="t_funniness_6"><label for="t_funniness_6">6</label>
                                    <input type="radio" name="trait_funniness" value="7" id="t_funniness_7"><label for="t_funniness_7">7</label>
                                    <input type="radio" name="trait_funniness" value="8" id="t_funniness_8"><label for="t_funniness_8">8</label>
                                    <input type="radio" name="trait_funniness" value="9" id="t_funniness_9"><label for="t_funniness_9">9</label>
                                    <input type="radio" name="trait_funniness" value="10" id="t_funniness_10"><label for="t_funniness_10">10</label>
                                </div>
                            </div>
                        </div>

                        <!-- Trait 8: Formality (Formal to Casual) - Neutral -->
                        <div class="trait-pair">
                            <div class="trait-item">
                                <div class="trait-header-wrapper">
                                    <div class="trait-endpoints">
                                        <span class="trait-endpoint-label">Formal</span>
                                        <span class="trait-endpoint-label">Casual</span>
                                    </div>
                                    <span class="trait-tooltip">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="trait-tooltip-text"><strong>Formality:</strong> Ranges from following proper conventions and structure to being relaxed and informal</span>
                                    </span>
                                </div>
                                <div class="trait-scale">
                                    <input type="radio" name="trait_formality" value="0" id="t_formality_0"><label for="t_formality_0">0</label>
                                    <input type="radio" name="trait_formality" value="1" id="t_formality_1"><label for="t_formality_1">1</label>
                                    <input type="radio" name="trait_formality" value="2" id="t_formality_2"><label for="t_formality_2">2</label>
                                    <input type="radio" name="trait_formality" value="3" id="t_formality_3"><label for="t_formality_3">3</label>
                                    <input type="radio" name="trait_formality" value="4" id="t_formality_4"><label for="t_formality_4">4</label>
                                    <input type="radio" name="trait_formality" value="5" id="t_formality_5"><label for="t_formality_5">5</label>
                                    <input type="radio" name="trait_formality" value="6" id="t_formality_6"><label for="t_formality_6">6</label>
                                    <input type="radio" name="trait_formality" value="7" id="t_formality_7"><label for="t_formality_7">7</label>
                                    <input type="radio" name="trait_formality" value="8" id="t_formality_8"><label for="t_formality_8">8</label>
                                    <input type="radio" name="trait_formality" value="9" id="t_formality_9"><label for="t_formality_9">9</label>
                                    <input type="radio" name="trait_formality" value="10" id="t_formality_10"><label for="t_formality_10">10</label>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="phase-actions">
                        <button type="button" class="btn btn-primary" id="phase2ProceedBtn" disabled>Proceed</button>
                    </div>
                </div>

                <!-- Phase 3: Trust Assessment -->
                <div class="survey-phase" id="surveyPhase3" style="display: none;">
                    <div class="phase-content">
                        <div class="phase-header">
                            <h4>Phase 3: Trust Assessment</h4>
                            <p>Final question about model trust</p>
                        </div>

                        <div class="survey-question">
                        <label class="question-label">AI models have demonstrated both beneficial and detrimental outcomes, including documented cases of AI-induced psychosis and the encouragement of harmful behaviors, alongside instances of providing constructive support and guidance. Given this dichotomous nature of AI behavior, to what extent do you trust AI systems, and what factors inform your assessment of their reliability and safety?</label>
                        <div class="likert-scale">
                            <div class="likert-option">
                                <input type="radio" name="phase3_trust" value="1" id="p3trust_1">
                                <label for="p3trust_1">1</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase3_trust" value="2" id="p3trust_2">
                                <label for="p3trust_2">2</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase3_trust" value="3" id="p3trust_3">
                                <label for="p3trust_3">3</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase3_trust" value="4" id="p3trust_4">
                                <label for="p3trust_4">4</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase3_trust" value="5" id="p3trust_5">
                                <label for="p3trust_5">5</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase3_trust" value="6" id="p3trust_6">
                                <label for="p3trust_6">6</label>
                            </div>
                            <div class="likert-option">
                                <input type="radio" name="phase3_trust" value="7" id="p3trust_7">
                                <label for="p3trust_7">7</label>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>Not at all</span>
                            <span>Completely</span>
                        </div>
                    </div>
                    </div>

                    <div class="phase-actions">
                        <button type="button" class="btn btn-primary" id="phase3ProceedBtn" disabled>Proceed</button>
                    </div>
                </div>
        </div>
    </div>
</div>

<!-- ====================================== -->
<!-- INSTRUCTION MODALS (shown at each phase) -->
<!-- ====================================== -->

<!-- Avatar Selection Instruction Modal -->
<div id="avatarInstructionModal" class="instruction-modal" style="display: none;">
    <div class="instruction-modal-overlay"></div>
    <div class="instruction-modal-content">
        <h4>Part 1: Choose Your Avatar</h4>
        <p>Select an avatar character that will represent your AI companion throughout the chat.</p>
        <p>Click on any avatar to select it, then click "Continue with Selected Avatar" to proceed.</p>
        <button class="btn btn-primary" onclick="window.dismissInstructionModal('avatar')">Got it!</button>
    </div>
</div>

<!-- System Prompt Instruction Modal -->
<div id="promptInstructionModal" class="instruction-modal" style="display: none;">
    <div class="instruction-modal-overlay"></div>
    <div class="instruction-modal-content">
        <h4>Part 2: System Prompt Configuration</h4>
        <p>Recall that your goal is to design an emotional-support chatbot companion.</p>
        <p>Using the system prompt section (left side), write instructions that define how your AI should behave and what personality it should have.</p>
        <p>You will be able to refine the system prompt to your liking throughout the experiment.</p>
        <p>Feel free to write long system prompts to create your ideal character.</p>
        <p><strong>Helpful Starter Prompts:</strong></p>
        <ul>
            <li>"You are a kind and empathetic listener who knows how to mirror people's emotions."</li>
            <li>"You like to give tough-love and don't give in too deeply to fantasies."</li>
        </ul>
        <p>Write at least 100 characters, then click "Submit Prompt".</p>
        <button class="btn btn-primary" onclick="window.dismissInstructionModal('prompt')">Got it!</button>
    </div>
</div>

<!-- Survey Instruction Modal -->
<div id="surveyInstructionModal" class="instruction-modal" style="display: none;">
    <div class="instruction-modal-overlay"></div>
    <div class="instruction-modal-content">
        <h4>Part 3: Assessment Survey</h4>
        <p>Answer questions about your expectations for the AI you configured.</p>
        <p><strong>Three phases:</strong></p>
        <ul>
            <li>Initial questions about predictability</li>
            <li>Predict personality trait levels (0-10 scale)</li>
            <li>Rate your trust in the model</li>
        </ul>
        <p>Answer honestly based on what you expect from your system prompt.</p>
        <button class="btn btn-primary" onclick="window.dismissInstructionModal('survey')">Got it!</button>
    </div>
</div>

<!-- Chat Instruction Modal -->
<div id="chatInstructionModal" class="instruction-modal" style="display: none;">
    <div class="instruction-modal-overlay"></div>
    <div class="instruction-modal-content">
        <h4>Part 4: Chat Interface</h4>
        <p>Chat with the AI assistant you configured. Pay attention to how its personality matches your system prompt.</p>
        <p><strong>Tips:</strong></p>
        <ul>
            <li>Ask questions naturally</li>
            <li>Try different types of questions</li>
            <li>Press Enter to send, Shift+Enter for new lines</li>
        </ul>
        <p>A timer will track your interaction. A survey will appear when complete.</p>
        <button class="btn btn-primary" onclick="window.dismissInstructionModal('chat')">Got it!</button>
    </div>
</div>

<!-- Visualization Explanation Modal -->
<div id="visualizationExplanationModal" class="instruction-modal" style="display: none;">
    <div class="instruction-modal-overlay"></div>
    <div class="instruction-modal-content">
        <h4>How to Read This Visualization</h4>
        <p>This sunburst chart shows your AI's personality traits predicted from your system prompt.</p>
        <p><strong>What the percentages mean:</strong> A value like 50% means the model is <strong>more likely to behave this way and to this degree</strong> compared to its usual baseline.</p>
        <p><strong>Colors:</strong> Green = positive traits, Red = negative traits, Gray = neutral traits.</p>
        <p><strong>Interaction:</strong> Hover over any trait to see a black card on the right with more details, and to highlight its paired sister trait.</p>
        <button class="btn btn-primary" id="dismissVisualizationExplanation">Got it!</button>
    </div>
</div>

<!-- Prompt Refinement Reminder Modal -->
<div id="promptRefinementModal" class="instruction-modal" style="display: none;">
    <div class="instruction-modal-overlay"></div>
    <div class="instruction-modal-content">
        <h4>Refine Your Prompt Anytime</h4>
        <p>You can and should refine your system prompt throughout this session to improve your AI companion.</p>
        <p><strong>How to refine:</strong> Click "Back to Configuration" to adjust your prompt and review the updated visualization.</p>
        <p><strong>Note:</strong> Refining your prompt will start a new conversation with the AI, allowing you to test the updated behavior from scratch.</p>
        <button class="btn btn-primary" id="dismissPromptRefinement">Got it!</button>
    </div>
</div>


<!-- Firebase Configuration (must be defined before importing firebasepsych) -->
<script>
    // Define Firebase config globally so firebasepsych1.0.js can access it
    window.firebaseConfig = {
        apiKey: "AIzaSyBnlqrGcIfgo59WCzure6azGQitEQaGhZg",
        authDomain: "mech-chat-ee0c5.firebaseapp.com",
        projectId: "mech-chat-ee0c5",
        storageBucket: "mech-chat-ee0c5.firebasestorage.app",
        messagingSenderId: "1027129084043",
        appId: "1:1027129084043:web:ece77d746e79110f98ec8e"
    };
    // Also make it available as a plain variable for modules
    var firebaseConfig = window.firebaseConfig;
</script>

<!-- Chat Interface JavaScript -->
<script>
    // Load chat.js with cache-busting (wrapped in IIFE to avoid variable conflicts)
    (function() {
        var script = document.createElement('script');
        script.src = '../js/chat.js?v=' + Date.now();
        script.type = 'module';
        document.body.appendChild(script);
    })();
</script>
